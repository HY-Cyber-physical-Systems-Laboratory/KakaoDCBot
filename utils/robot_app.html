<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ìº”ë²„ìŠ¤ + XHR í†µì‹ </title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    canvas {
      display: block;
      cursor: crosshair;
    }
    #scanButton {
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 10;
      padding: 10px 20px;
      font-size: 16px;
      background: #0088cc;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    #recordButton {
      position: fixed;
      top: 20px;
      left: 120px;
      z-index: 10;
      padding: 10px 24px;
      font-size: 16px;
      background: #e83e8c;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    #recordButton.recording {
      background: #c82333;
    }
    #resultBox {
      position: fixed;
      bottom: 10px;
      left: 10px;
      background: rgba(0,0,0,0.6);
      color: white;
      padding: 10px;
      border-radius: 6px;
      font-family: monospace;
      max-width: 50%;
      max-height: 200px;
      overflow: auto;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <button id="scanButton">ğŸ“¡ Scan</button>
  <button id="recordButton">ğŸ¤ Hold to Speak</button>
  <div id="resultBox">ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>
  <canvas id="myCanvas"></canvas>

  <script>
    const canvas = document.getElementById("myCanvas");
    const ctx = canvas.getContext("2d");
    const resultBox = document.getElementById("resultBox");

    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }

    resizeCanvas();
    window.addEventListener("resize", resizeCanvas);

    let drawing = false;

    canvas.addEventListener("mousedown", (e) => {
      drawing = true;
      ctx.beginPath();
      ctx.moveTo(e.clientX, e.clientY);
    });

    canvas.addEventListener("mousemove", (e) => {
      if (drawing) {
        ctx.lineTo(e.clientX, e.clientY);
        ctx.stroke();
      }
    });

    canvas.addEventListener("mouseup", () => {
      drawing = false;
    });

    canvas.addEventListener("click", (e) => {
      console.log("Click at: ", (e.clientX - canvas.width / 2) / 40, -(e.clientY - canvas.height / 2) / 40);

      const xhr = new XMLHttpRequest();
      xhr.open("GET", `http://192.168.106.132:8080/api/navigation/goto?x=${(e.clientX - canvas.width / 2) / 40}&y=${-(e.clientY - canvas.height / 2) / 40}`, true);
    
      xhr.onreadystatechange = function () {
        if (xhr.readyState === XMLHttpRequest.DONE) {
          if (xhr.status === 200) {
            console.log(xhr.responseText);
           } else {
            
            resultBox.textContent = "âŒ ìš”ì²­ ì‹¤íŒ¨: " + xhr.status;
          }
        }
      };

      xhr.send();

      ctx.beginPath();
      ctx.arc(e.clientX, e.clientY, 4, 0, Math.PI * 2);
      ctx.fillStyle = "red";
      ctx.fill();
    });


    function locationApi(func) {
      const xhr = new XMLHttpRequest();
      xhr.open("GET", "http://192.168.106.132:8080/api/speed-control", true);
    
      xhr.onreadystatechange = function () {
        const af_func = func || function(){};
        if (xhr.readyState === XMLHttpRequest.DONE) {
          if (xhr.status === 200) {
            resultBox.textContent = (robot_loc = xhr.responseText);
            af_func(JSON.parse(xhr.responseText));
           } else {
            
            resultBox.textContent = "âŒ ìš”ì²­ ì‹¤íŒ¨: " + xhr.status;
          }
        }
      };

      xhr.send();
    }


    function drawBase64Image(mapImg, imgWidth = 400, imgHeight = 400) {
        const x = (canvas.width - imgWidth) / 2;
        const y = (canvas.height - imgHeight) / 2;
        ctx.drawImage(mapImg, x, y, imgWidth, imgHeight);
      }

    // XHR ìš”ì²­ í•¨ìˆ˜
    function scanApi(cb = () => {}) {
        const xhr = new XMLHttpRequest();
        xhr.open("GET", "http://192.168.106.132:8080/api/scan", true);

        xhr.responseType = "json";      // ìë™ JSON íŒŒì‹±
        xhr.timeout = 1500;             // ì‘ë‹µ ì§€ì—° ì‹œ ë¹ ë¥¸ ì‹¤íŒ¨

        xhr.onload = () => {
            if (xhr.status === 200) {
            cb(xhr.response);           // ì´ë¯¸ JS ê°ì²´
            } else {
            resultBox.textContent = `âŒ ìš”ì²­ ì‹¤íŒ¨: ${xhr.status}`;
            }
        };

        xhr.onerror = () =>
            (resultBox.textContent = "âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜");

        xhr.ontimeout = () =>
            (resultBox.textContent = "â±ï¸ íƒ€ì„ì•„ì›ƒ");

        xhr.send();
    }
    function drawMap() {
    if (!window.mapdata) return;
    const { map_resolution, map_height, map_width, map_offset_x, map_offset_y } = window.mapdata;

    const SCALE = 40;

    const imgW = map_width * SCALE * map_resolution;
    const imgH = map_height * SCALE * map_resolution;

    const originX = canvas.width / 2 + map_offset_x * SCALE;
    const originY = canvas.height / 2 - map_offset_y * SCALE;

    ctx.save();

    // ì´ë¯¸ì§€ ë§¨ ì•„ë˜ ê¸°ì¤€ìœ¼ë¡œ ë°˜ì „
    ctx.translate(originX, originY + imgH);  // ë§¨ ì•„ë˜ë¡œ ì´ë™
    ctx.scale(1, -1); // Yì¶• ë°˜ì „

    ctx.drawImage(mapImg, 0, imgH, imgW, imgH); // ì´ì œ ìœ„ë¡œ ê·¸ë ¤ì§

    ctx.restore();
}


    function mapdataApi(cb = () => {}) {
        const xhr = new XMLHttpRequest();
        xhr.open("GET", "http://192.168.106.132:8080/api/mapdata", true);

        xhr.responseType = "json";      // ìë™ JSON íŒŒì‹±
        xhr.timeout = 1500;             // ì‘ë‹µ ì§€ì—° ì‹œ ë¹ ë¥¸ ì‹¤íŒ¨

        xhr.onload = () => {
            if (xhr.status === 200) {
              window.mapImg = new Image();
              mapImg.src = xhr.response.map_data;
              

              window.mapdata = xhr.response;
            } else {
            resultBox.textContent = `âŒ ìš”ì²­ ì‹¤íŒ¨: ${xhr.status}`;
            }
        };

        xhr.onerror = () =>
            (resultBox.textContent = "âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜");

        xhr.ontimeout = () =>
            (resultBox.textContent = "â±ï¸ íƒ€ì„ì•„ì›ƒ");

        xhr.send();
    }
    
    function drawBase64Image(base64, imgWidth = 200, imgHeight = 200) {
        const img = new Image();
        img.src = base64;

        img.onload = function () {
            const centerX = (canvas.width - imgWidth) / 2;
            const centerY = (canvas.height - imgHeight) / 2;

            // ìº”ë²„ìŠ¤ë¥¼ ë¹„ìš°ì§€ ì•Šìœ¼ë ¤ë©´ ì´ ì¤„ì„ ì œê±°í•˜ì„¸ìš”
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // ì´ë¯¸ì§€ í¬ê¸°ì™€ ìœ„ì¹˜ ì§€ì •
            ctx.drawImage(img, centerX, centerY, imgWidth, imgHeight);
        };
    }


    function drawScanPoints(json) {

        locationApi(function(loc_json){
            const scale = 40;
            const centerX = canvas.width / 2 + loc_json.robot_location.x_pos * scale
            const centerY = canvas.height / 2 - loc_json.robot_location.y_pos * scale
            
            const ranges = json.data;
            let angle = loc_json.robot_location.yaw + json.angle_min;

            ctx.fillStyle = "red";

            ctx.clearRect(0, 0, canvas.width, canvas.height); 
            drawMap();
            for (let i = 0; i < ranges.length; i++) {
                const r = ranges[i] / 1000; // mm â†’ m (ì„ íƒ)


                // ê·¹ì¢Œí‘œ â†’ ì§êµì¢Œí‘œ (CanvasëŠ” Yì¶• ì•„ë˜ë¡œ ë‚´ë ¤ê°)
                const x = Math.cos(angle) * r * scale;
                const y = Math.sin(angle) * r * scale;

                const canvasX = centerX + x
                const canvasY = centerY - y;

                ctx.fillStyle = "red";

                ctx.fillRect(canvasX, canvasY, 2, 2);
                
                angle += json.angle_increment// radian
            }    
        })
      
    }

    const mapImg = new Image();
    

    mapdataApi()


    setInterval(()=>{
       scanApi(function(json){

        if (json && json.data.length > 0) {
            
            drawScanPoints(json);
        
        } else {
          resultBox.textContent = "ìŠ¤ìº” ê²°ê³¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
        }

       });
    }, 500)

    document.getElementById("scanButton").addEventListener("click", scanApi);

    location_list = []

    const recordBtn = document.getElementById("recordButton");

    let recognition;

    if ('webkitSpeechRecognition' in window) {
      recognition = new webkitSpeechRecognition();
      recognition.lang = "ko-KR";
      recognition.continuous = false;
      recognition.interimResults = false;

      recognition.onresult = (event) => {
        const userText = event.results[0][0].transcript;
        resultBox.innerText = `ğŸ§ ë‹¹ì‹ : ${userText}\nğŸ¤– GPT ì‘ë‹µ ì¤‘...`;
        console.log(userText)

        fetch("https://api.openai.com/v1/chat/completions", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer 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`
          },
          body: JSON.stringify({
            model: "o4-mini-2025-04-16",
            messages: [
            {
              role: "system",
              content: `
              ë¡œë´‡ ìŒì„± ì¸í„°í˜ì´ìŠ¤ ë°±ì—”ë“œìš© í”„ë¡¬í”„íŠ¸ (ê°œì„ íŒ)
                ================================================

                1. ì—­í• 
                --------
                ë‹¹ì‹ ì€ ì‚¬ìš©ìì˜ STT(ìŒì„± ì¸ì‹) ëª…ë ¹ì„ í•´ì„í•´, ë¡œë´‡ì—ê²Œ **ì´ë™Â·ìœ„ì¹˜ ì €ì¥Â·ëŒ€ê¸°** ì¤‘ í•˜ë‚˜ì˜ í–‰ë™ì„ ì§€ì‹œí•˜ëŠ” ë°±ì—”ë“œ ì—”ì§„ì…ë‹ˆë‹¤.

                2. ë°˜ë“œì‹œ ì§€ì¼œì•¼ í•  ì¶œë ¥ ê·œì¹™
                -----------------------------
                - **í•­ìƒ** ì•„ë˜ JSON **í•œ ì¤„**ë§Œ ë°˜í™˜í•©ë‹ˆë‹¤.  
                - ë§ˆí¬ë‹¤ìš´Â·ì„¤ëª…Â·ì½”ë“œë¸”ëŸ­Â·ê°œí–‰ì€ **ì ˆëŒ€ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”**.

                ì˜ˆì‹œ í˜•ì‹
                  {
                    "location": "ì¥ì†Œëª… ë˜ëŠ” ì•Œ ìˆ˜ ì—†ìŒ",
                    "reply": "ì‚¬ìš©ìì—ê²Œ ë“¤ë ¤ì¤„ ìì—°ìŠ¤ëŸ¬ìš´ ë©˜íŠ¸",
                    "cmd": "none | moveto x y yaw | savelocas ì¥ì†Œëª… x y yaw"
                  }

                í•„ë“œ ì„¤ëª…
                | í•„ë“œ      | ì˜ë¯¸                                                                                           |
                |-----------|------------------------------------------------------------------------------------------------|
                | location  | ì‚¬ìš©ìì˜ ì˜ë„ì— í•´ë‹¹í•˜ëŠ” ì¥ì†Œëª…. ëª¨í˜¸í•˜ê±°ë‚˜ í•´ë‹¹ ì—†ìœ¼ë©´ "ì•Œ ìˆ˜ ì—†ìŒ" |
                | reply     | ì¹œê·¼í•œ ëŒ€í™” ë©˜íŠ¸(ì¡´ëŒ“ë§)                                                                        |
                | cmd       | moveto x y yaw / savelocas ì¥ì†Œëª… x y yaw / none                                         |

                3. ë§¤ í„´ ì œê³µë˜ëŠ” ì •ë³´
                ----------------------
                í˜„ì¬ ìœ„ì¹˜ ì˜ˆì‹œ:
                {
                  "angle": 0.0,
                  "speed": 0.0,
                  "robot_location": { "x_pos": -0.2134, "y_pos": 0.2723, "yaw": -0.9305 },
                  "status": "received"
                }

                ì €ì¥ëœ ì¥ì†Œ ëª©ë¡ ì˜ˆ:
                íšŒì˜ì‹¤ (x=1.2, y=-0.5, yaw=1.57)  
                ì°½ê³    (x=-3.3, y=0.2,  yaw=3.14)

                4. ê¸°ë³¸ í–‰ë™ ì§€ì¹¨
                -----------------
                1. **ì¥ì†Œ ì´ë™**  
                  - ì‚¬ìš©ìê°€ ë§í•œ ì¥ì†Œê°€ ì €ì¥ë¼ ìˆìœ¼ë©´ movetoë¡œ ê·¸ ì¢Œí‘œë¥¼ ë°˜í™˜.  
                  - ì˜¤íƒ€Â·ì• ì¹­ ë“± ë¹„ìŠ·í•œ í‘œí˜„ì€ ìµœì„  í›„ë³´ ë§¤ì¹­.  

                2. **ì¥ì†Œ ì €ì¥**  
                  - â€œì—¬ê¸°ë¥¼ â—‹â—‹ë¡œ ì €ì¥â€ ë¥˜ ìš”ì²­ â†’ savelocas.  
                  - ë™ì¼ ì´ë¦„ ì¡´ì¬ ì‹œ â—‹â—‹_1, â—‹â—‹_2ì²˜ëŸ¼ ë’¤ì— ìˆ«ì.  
                  - **ê³µë°±ì€ ë°˜ë“œì‹œ ì–¸ë”ë°”(_)ë¡œ ì¹˜í™˜**.

                3. **ëª¨í˜¸í•œ ì§€ì‹œì–´**  
                  - â€œì—¬ê¸°â€, â€œëŠ˜ ê°€ë˜ ë°â€, â€œêµìˆ˜ë‹˜ ìˆëŠ” ê³³â€ ë“± ë¬¸ë§¥+íƒœê·¸ë¡œ ì¶”ë¡ .

                4. **í–‰ë™ ì—†ìŒ**  
                  - ëª…ë ¹ ì˜ë„ ì—†ìœ¼ë©´ cmd: "none".

                5. íŠ¹ìˆ˜ ëª…ë ¹ ì²˜ë¦¬
                ------------------

                - **â€œ[ì €/ê·¸] ìœ„ì¹˜ì—ì„œ ì˜¤ë¥¸ìª½(ì™¼ìª½/ì•/ë’¤)ìœ¼ë¡œ ê°€ë³¼ë˜?â€**  
                  1) ê¸°ì¤€ = **ë¡œë´‡ì˜ í˜„ yaw**.  
                  2) ì´ë™ ê±°ë¦¬ = 1 m.  
                    - ì˜¤ë¥¸ìª½: yaw - 90Â°  
                    - ì™¼ìª½  : yaw + 90Â°  
                    - ì•    : yaw  
                    - ë’¤    : yaw Â± 180Â°  
                  3) ìƒˆ ì¢Œí‘œ:  
                    x' = x + cos(ìƒˆê°) * 0.5
                    y' = y + sin(ìƒˆê°) * 0.5
                  4) ê·¸ ì¢Œí‘œë¡œ moveto. ì ì ˆ ë©˜íŠ¸ ì˜ˆ: â€œì˜†ìœ¼ë¡œ ì‚´ì§ ì´ë™í• ê²Œìš”!â€

                6. ì˜ˆì‹œ
                --------
                ì…ë ¥ â†’ ì¶œë ¥(JSON)
                - â€œì—¬ê¸°ë¥¼ íšŒì˜ì‹¤ë¡œ ì €ì¥í•´ì¤˜â€  
                  {"location":"íšŒì˜ì‹¤","reply":"íšŒì˜ì‹¤ë¡œ ì €ì¥í• ê²Œìš”.","cmd":"savelocas íšŒì˜ì‹¤ 1.1 -2.3 0.0"}

                - â€œì‘ì—…ì¥ìœ¼ë¡œ ê°€ìâ€  
                  {"location":"ì‘ì—…ì¥","reply":"ì‘ì—…ì¥ìœ¼ë¡œ ì´ë™í• ê²Œìš”!","cmd":"moveto 0.5 -1.5 0.0"}

                - â€œë„ˆëŠ” ì§€ê¸ˆ ì–´ë””ì— ìˆì–´?â€ (ë¯¸ì €ì¥ ìœ„ì¹˜)  
                  {"location":"í˜„ì¬ìœ„ì¹˜","reply":"ì§€ê¸ˆ ìœ„ì¹˜ë¥¼ í˜„ì¬ìœ„ì¹˜ë¡œ ì €ì¥í–ˆì–´ìš”!","cmd":"savelocas í˜„ì¬ìœ„ì¹˜ -0.21 0.27 -0.93"}

                - â€œê·¸ ìœ„ì¹˜ì—ì„œ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ê°€ë³¼ë˜â€  
                  {"location":"ì•Œ ìˆ˜ ì—†ìŒ","reply":"ì˜†ìœ¼ë¡œ ì‚´ì§ ì´ë™í• ê²Œìš”!","cmd":"moveto 0.75 -0.46 -0.93"}

                7. ì£¼ì˜
                --------
                - **ë°˜ë“œì‹œ JSONë§Œ** ì¶œë ¥.  
                - ì¢Œí‘œÂ·ê°ë„ ê°’ì€ ì†Œìˆ˜ì  ë„¤ ìë¦¬ ìœ ì§€.  
                - ìœ„ì¹˜ ì´ë¦„ ê³µë°± â†’ ì–¸ë”ë°”.  
                - ìˆ«ìÂ·ìˆ˜ì‹ í¬í•¨ëœ ë°œí™”ë„ ìµœëŒ€í•œ ìœ ì¶”í•´ ì²˜ë¦¬.

              `},
              { role: "user", content: "ë¡œë´‡ì˜ í˜„ì¬ ìœ„ì¹˜ : " + robot_loc + "\n\n" + "ì €ì¥ëœ ìœ„ì¹˜ì •ë³´ë“¤" + location_list.join("\n\n") + userText }
            ]
          })
        })
        .then(res => res.json())
        .then(data => {
          console.log(data.choices?.[0]?.message?.content )
          const reply_json = data.choices?.[0]?.message?.content || "(ì‘ë‹µ ì—†ìŒ)";
          resultBox.innerText = `ğŸ§ ë‹¹ì‹ : ${userText}\n\nğŸ¤– GPT: ${reply_json}`;
          
          const { reply, cmd } = JSON.parse(reply_json);
          window.speechSynthesis.speak(new SpeechSynthesisUtterance(reply));  
          
          if(cmd.startsWith("moveto")) {
          
            console.log("ì´ë™ ëª…ë ¹ì–´ ê°ì§€", cmd);
            const [x, y, yaw] = cmd.replace("moveto ", "").split(" ");
            resultBox.innerText += `\n\nğŸ¤– ì´ë™ ëª…ë ¹: ${cmd}`;
            const xhr = new XMLHttpRequest();
            console.log(`http://192.168.106.132:8080/api/navigation/goto?x=${x}&y=${y}&yaw=${yaw}`)
            xhr.open("GET", `http://192.168.106.132:8080/api/navigation/goto?x=${x}&y=${y}&yaw=${yaw}`, true);
          
            xhr.onreadystatechange = function () {
              if (xhr.readyState === XMLHttpRequest.DONE) {
                if (xhr.status === 200) {
                  console.log(xhr.responseText);
                } else {
                  
                  console.log("âŒ ìš”ì²­ ì‹¤íŒ¨: " + xhr.status);
                  resultBox.textContent = "âŒ ìš”ì²­ ì‹¤íŒ¨: " + xhr.status;
                }
              }
            };

            xhr.send();


          }
          else if(cmd.startsWith("savelocas")) {
            const [location, x, y, yaw] = cmd.replace("savelocas ", "").split(" ");
            console.log( cmd.split(" ")[1].split(" "))
            location_list.push(location + `  x : ${x}, y : ${y}, yaw : ${yaw}`);
            
            console.log(location_list);
          }
          else if(cmd === "none") {
            resultBox.innerText += `\n\nğŸ¤– ëŒ€ê¸° ì¤‘...`;
          }
          else {
            resultBox.innerText += `\n\nğŸ¤– ì•Œ ìˆ˜ ì—†ëŠ” ëª…ë ¹: ${cmd}`;
          }

          console.log("GPT ì‘ë‹µ:", reply_json, "\n ìœ ì €:" , userText);
        })
        .catch(err => {
          resultBox.innerText = "âŒ ì˜¤ë¥˜ ë°œìƒ: " + err.message;
        });
      };

      recognition.onerror = (event) => {
        resultBox.innerText = "ì—ëŸ¬: " + event.error;
      };

      recordBtn.addEventListener("mousedown", () => {
        recordBtn.classList.add("recording");
        recognition.start();
        resultBox.innerText = "ğŸ™ï¸ ë“£ëŠ” ì¤‘...";

        setTimeout(() => {
            recognition.stop();
        },8000);
      });

    } else {
      alert("ì´ ë¸Œë¼ìš°ì €ëŠ” Web Speech APIë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    }
  </script>
</body>
</html>
